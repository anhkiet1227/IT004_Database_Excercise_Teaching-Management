/*
Họ tên: Võ Anh Kiệt
Lớp: ATTN2020
Bài thực hành  ngày 09/10/2021
*/

--Buổi 1---------------------------------------------------------------------------------------------------------------------------------------
/*
Câu 1:
Tạo quan hệ và khai báo tất cả các ràng buộc khóa chính, khóa ngoại. 
Thêm vào 3 thuộc tính GHICHU, DIEMTB, XEPLOAI cho quan hệ HOCVIEN.
*/
--DROP DATABASE QLGV1;
CREATE DATABASE QLGV1; 
-- Tạo csdl

USE QLGV1; 
-- Chú ý trước khi chạy chương trình thì chạy dòng này 
--để có thể truy cập csdl

SET DATEFORMAT DMY; --format ngày/tháng/năm

-- Tạo các table và các thành phần, khóa chính nhưng chưa tạo khóa ngoại

CREATE TABLE KHOA(
	MAKHOA CHAR(4) ,
	TENKHOA NVARCHAR(40),
	NGTLAP SMALLDATETIME,
	TRGKHOA CHAR(4),
	PRIMARY KEY(MAKHOA)
)

CREATE TABLE MONHOC(
	MAMH CHAR(10),
	TENMH NVARCHAR(40),
	TCLT TINYINT,
	TCTH TINYINT,
	MAKHOA CHAR(4),
	PRIMARY KEY(MAMH)
)

CREATE TABLE DIEUKIEN(
	MAMH CHAR(10),
	MAMH_TRUOC CHAR(10)
)

CREATE TABLE GIAOVIEN(
	MAGV CHAR(4),
	HOTEN NVARCHAR(40),
	HOCVI NVARCHAR(10),
	HOCHAM NVARCHAR(10),
	GIOITINH NVARCHAR(3),
	NGAYSINH SMALLDATETIME,
	NGVL SMALLDATETIME,
	HESO NUMERIC(4,2),
	MUCLUONG MONEY,
	MAKHOA CHAR(4),
	PRIMARY KEY (MAGV)
)

CREATE TABLE LOP(
	MALOP CHAR(3),
	TENLOP NVARCHAR(40),
	TRGLOP CHAR(5),
	SISO TINYINT,
	MAGVCN CHAR(4),
	PRIMARY KEY (MALOP)
)

CREATE TABLE HOCVIEN(
	MAHV CHAR(5),
	HO NVARCHAR(40),
	TEN NVARCHAR(10),
	NGSINH SMALLDATETIME,
	GIOITINH NVARCHAR(3),
	NOISINH VARCHAR(40),
	MALOP CHAR(3),
	PRIMARY KEY (MAHV)
)

CREATE TABLE GIANGDAY(
	MALOP CHAR(3),
	MAMH CHAR(10),
	MAGV CHAR(4),
	HOCKY TINYINT,
	NAM SMALLINT,
	TUNGAY SMALLDATETIME,
	DENNGAY SMALLDATETIME,
)

CREATE TABLE KETQUATHI(
	MAHV CHAR(5),
	MAMH CHAR(10),
	LANTHI TINYINT,
	NGTHI SMALLDATETIME,
	DIEM NUMERIC(4,2),
	KQUA VARCHAR(10)
)

/*
Chú ý phần khóa ngoại, không nên thêm trực tiếp vào phần tạo bảng
mà nên để tách ra một phần riêng sử dụng add constraint để thêm
để tránh xảy ra lỗi nhiều nhất có thể
nếu cài khóa ngoại vô trước phải đảm bảo dữ liệu đầu vào là chính xác
*/

--Thêm dữ liệu vào bảng Khoa

INSERT INTO KHOA VALUES('KHMT',N'Khoa học máy tính','7/6/2005','GV01')
INSERT INTO KHOA VALUES('HTTT',N'Hệ thống thông tin','7/6/2005','GV02')
INSERT INTO KHOA VALUES('CNPM',N'Công nghệ phần mềm','7/6/2005','GV04')
INSERT INTO KHOA VALUES('MTT',N'Mạng và truyền thông','20/10/2005','GV03')
INSERT INTO KHOA VALUES('KTMT',N'Kỹ thuật máy tính','20/12/2005','Null')

--Cập nhật trưởng khoa trong bảng khoa

UPDATE KHOA
SET TRGKHOA='GV01'
WHERE MAKHOA='KTMT'

UPDATE KHOA
SET TRGKHOA='GV02'
WHERE MAKHOA='HTTT'

UPDATE KHOA
SET TRGKHOA='GV04'
WHERE MAKHOA='CNPM'

UPDATE KHOA
SET TRGKHOA='GV04'
WHERE MAKHOA='MTT'

UPDATE KHOA
SET TRGKHOA=NULL
WHERE MAKHOA='KTMT'

--Thêm dữ liệu vào bảng lớp

INSERT INTO LOP VALUES('K11',N'Lớp 1 khóa 1','K1108',11,'GV07')
INSERT INTO LOP VALUES('K12',N'Lớp 2 khóa 1','K1205',12,'GV09')
INSERT INTO LOP VALUES('K13',N'Lớp 3 khóa 1','K1305',12,'GV14')

--Thêm dữ liệu vào bảng môn học

INSERT INTO MONHOC VALUES('THDC',N'Tin học đại cương',4,1,'KHMT')
INSERT INTO MONHOC VALUES('CTRR',N'Cấu trúc rời rạc',5,0,'KHMT')
INSERT INTO MONHOC VALUES('CSDL',N'Cơ sở dữ liệu',3,1,'HTTT')
INSERT INTO MONHOC VALUES('CTDLGT',N'Cấu trúc dữ liệu giải thuật',3,1,'KHMT')
INSERT INTO MONHOC VALUES('PTTKTT',N'Phân tích thiết kế thuật toán',3,0,'KHMT')
INSERT INTO MONHOC VALUES('DHMT',N'Đồ họa máy tính',3,1,'KHMT')
INSERT INTO MONHOC VALUES('KTMT',N'Kiến trúc máy tính',3,0,'KTMT')
INSERT INTO MONHOC VALUES('TKCSDL',N'Thiết kế cơ sở dữ liệu',3,1,'HTTT')
INSERT INTO MONHOC VALUES('PTTKHTTT',N'Phân tích thiết kế hệ thống thông tin',4,1,'HTTT')
INSERT INTO MONHOC VALUES('HDH',N'Hệ điều hành',4,0,'KTMT')
INSERT INTO MONHOC VALUES('NMCNPM',N'Nhập môn công nghệ phần mềm',3,0,'CNPM')
INSERT INTO MONHOC VALUES('LTCFW',N'Lập trình C for win',3,1,'CNPM')
INSERT INTO MONHOC VALUES('LTHDT',N'Lập trình hướng đối tượng',3,1,'CNPM')

--Thêm dữ liệu vào bảng giáo viên

INSERT INTO GIAOVIEN VALUES('GV01',N'Hồ Thanh Sơn','PTS','GS',N'Nam','2/5/1950','11/1/2004',5,2250000,'KHMT')
INSERT INTO GIAOVIEN VALUES('GV02',N'Trần Tâm Thành','TS','PGS',N'Nam','17/12/1965','20/4/2004',4.5,2025000,'HTTT')
INSERT INTO GIAOVIEN VALUES('GV03',N'Đỗ Nghiêm Phụng','TS','GS',N'Nữ','1/8/1950','23/9/2004',4,1800000,'CNPM')
INSERT INTO GIAOVIEN VALUES('GV04',N'Trần Nam Sơn','TS','PGS',N'Nam','22/2/1961','12/1/2005',4.5,2025000,'KTMT')
INSERT INTO GIAOVIEN VALUES('GV05',N'Mai Thanh Danh','ThS','GV',N'Nam','12/3/1958','12/1/2005',3,1350000,'HTTT')
INSERT INTO GIAOVIEN VALUES('GV06',N'Trần Doãn Hưng','TS','GV',N'Nam','11/3/1953','12/1/2005',4.5,2025000,'KHMT')
INSERT INTO GIAOVIEN VALUES('GV07',N'Nguyễn Minh Tiến','ThS','GV',N'Nam','23/11/1971','1/3/2005',4,1800000,'KHMT')
INSERT INTO GIAOVIEN VALUES('GV08',N'Lê Thị Trân','KS','Null',N'Nữ','26/3/1974','1/3/2005',1.69,760500,'KHMT')
INSERT INTO GIAOVIEN VALUES('GV09',N'Nguyễn Tố Loan','ThS','GV',N'Nữ','31/12/1966','1/3/2005',4,1800000,'HTTT')
INSERT INTO GIAOVIEN VALUES('GV10',N'Lê Trần Ánh Loan','KS','Null',N'Nữ','17/7/1972','1/3/2005',1.86,837000,'CNPM')
INSERT INTO GIAOVIEN VALUES('GV11',N'Hồ Thanh Tùng','CN','GV',N'Nam','12/1/1980','15/5/2005',2.67,1201500,'MTT')
INSERT INTO GIAOVIEN VALUES('GV12',N'Trần Vân Anh','CN','Null',N'Nữ','29/3/1981','15/5/2005',1.69,760500,'CNPM')
INSERT INTO GIAOVIEN VALUES('GV13',N'Nguyễn Linh Đan','CN','Null',N'Nữ','23/5/1980','15/5/2005',1.69,760500,'KTMT')
INSERT INTO GIAOVIEN VALUES('GV14',N'Trương Minh Châu','ThS','GV',N'Nữ','30/11/1976','15/5/2005',3,1350000,'MTT')
INSERT INTO GIAOVIEN VALUES('GV15',N'Lê Thanh Hà','ThS','GV',N'Nam','4/5/1978','15/5/2005',3,1350000,'KHMT')

--Thêm dữ liệu vào bảng giảng dạy

INSERT INTO GIANGDAY VALUES('K11','THDC','GV07',1,2006,'2/1/2006','12/5/2006')
INSERT INTO GIANGDAY VALUES('K12','THDC','GV06',1,2006,'2/1/2006','12/5/2006')
INSERT INTO GIANGDAY VALUES('K13','THDC','GV15',1,2006,'2/1/2006','12/5/2006')
INSERT INTO GIANGDAY VALUES('K11','CTRR','GV02',1,2006,'9/1/2006','17/5/2006')
INSERT INTO GIANGDAY VALUES('K12','CTRR','GV02',1,2006,'9/1/2006','17/5/2006')
INSERT INTO GIANGDAY VALUES('K13','CTRR','GV08',1,2006,'9/1/2006','17/5/2006')
INSERT INTO GIANGDAY VALUES('K11','CSDL','GV05',2,2006,'1/6/2006','15/7/2006')
INSERT INTO GIANGDAY VALUES('K12','CSDL','GV09',2,2006,'1/6/2006','15/7/2006')
INSERT INTO GIANGDAY VALUES('K13','CTDLGT','GV15',2,2006,'1/6/2006','15/7/2006')
INSERT INTO GIANGDAY VALUES('K13','CSDL','GV05',3,2006,'1/8/2006','15/12/2006')
INSERT INTO GIANGDAY VALUES('K13','DHMT','GV07',3,2006,'1/8/2006','15/12/2006')
INSERT INTO GIANGDAY VALUES('K11','CTDLGT','GV15',3,2006,'1/8/2006','15/12/2006')
INSERT INTO GIANGDAY VALUES('K12','CTDLGT','GV15',3,2006,'1/8/2006','15/12/2006')
INSERT INTO GIANGDAY VALUES('K11','HDH','GV04',1,2007,'2/1/2007','18/2/2007')
INSERT INTO GIANGDAY VALUES('K12','HDH','GV04',1,2007,'2/1/2007','20/3/2007')
INSERT INTO GIANGDAY VALUES('K11','DHMT','GV07',1,2007,'18/2/2007','20/3/2007')

--Thêm dữ liệu vào bảng điều kiện

INSERT INTO DIEUKIEN VALUES('CSDL','CTRR')
INSERT INTO DIEUKIEN VALUES('CSDL','CTDLGT')
INSERT INTO DIEUKIEN VALUES('CTDLGT','THDC')
INSERT INTO DIEUKIEN VALUES('PTTKTT','THDC')
INSERT INTO DIEUKIEN VALUES('PTTKTT','CTDLGT')
INSERT INTO DIEUKIEN VALUES('DHMT','THDC')
INSERT INTO DIEUKIEN VALUES('LTHDT','THDC')
INSERT INTO DIEUKIEN VALUES('PTTKHTTT','CSDL')

--Thêm dữ liệu vào bảng học viên

INSERT INTO HOCVIEN VALUES('K1101',N'Nguyễn Văn',N'A','27/1/1986',N'Nam',N'TpHCM','K11')
INSERT INTO HOCVIEN VALUES('K1102',N'Trần Ngọc',N'Hân','14/3/1986',N'Nữ',N'Kiên Giang','K11')
INSERT INTO HOCVIEN VALUES('K1103',N'Hà Duy',N'Lập','18/4/1986',N'Nam',N'Nghệ An','K11')
INSERT INTO HOCVIEN VALUES('K1104',N'Trần Ngọc',N'Linh','30/3/1986',N'Nữ',N'Tây Ninh','K11')
INSERT INTO HOCVIEN VALUES('K1105',N'Trần Minh',N'Long','27/2/1986',N'Nam',N'TpHCM','K11')
INSERT INTO HOCVIEN VALUES('K1106',N'Lê Nhật',N'Minh','24/1/1986',N'Nam',N'TpHCM','K11')
INSERT INTO HOCVIEN VALUES('K1107',N'Nguyễn Như',N'Nhựt','27/1/1986',N'Nam',N'Hà Nội','K11')
INSERT INTO HOCVIEN VALUES('K1108',N'Nguyễn Mạnh',N'Tâm','27/2/1986',N'Nam',N'Kiên Giang','K11')
INSERT INTO HOCVIEN VALUES('K1109',N'Phan Thị Thanh',N'Tâm','27/1/1986',N'Nữ',N'Vĩnh Long','K11')
INSERT INTO HOCVIEN VALUES('K1110',N'Lê Hoài',N'Thương','5/2/1986',N'Nữ',N'Cần Thơ','K11')
INSERT INTO HOCVIEN VALUES('K1111',N'Lê Hà',N'Vinh','25/12/1986',N'Nam',N'Vĩnh Long','K11')
INSERT INTO HOCVIEN VALUES('K1201',N'Nguyễn Văn',N'B','11/2/1986',N'Nam',N'TpHCM','K12')
INSERT INTO HOCVIEN VALUES('K1202',N'Nguyễn Thị Kim',N'Duyên','18/1/1986',N'Nữ',N'TpHCM','K12')
INSERT INTO HOCVIEN VALUES('K1203',N'Trần Thị Kim',N'Duyên','17/9/1986',N'Nữ',N'TpHCM','K12')
INSERT INTO HOCVIEN VALUES('K1204',N'Trương Mỹ',N'Hạnh','19/5/1986',N'Nữ',N'Đồng Nai','K12')
INSERT INTO HOCVIEN VALUES('K1205',N'Nguyễn Thành',N'Nam','17/4/1986',N'Nam',N'TpHCM','K12')
INSERT INTO HOCVIEN VALUES('K1206',N'Nguyễn Thị Trúc',N'Thanh','4/3/1986',N'Nữ',N'Kiên Giang','K12')
INSERT INTO HOCVIEN VALUES('K1207',N'Trần Thị Bích',N'Thụy','8/2/1986',N'Nữ',N'Nghệ An','K12')
INSERT INTO HOCVIEN VALUES('K1208',N'Huỳnh Thị Kim',N'Triệu','8/4/1986',N'Nữ',N'Tây Ninh','K12')
INSERT INTO HOCVIEN VALUES('K1209',N'Phạm Thanh',N'Triệu','23/2/1986',N'Nam',N'TpHCM','K12')
INSERT INTO HOCVIEN VALUES('K1210',N'Ngô Thanh',N'Tuấn','14/2/1986',N'Nam',N'TpHCM','K12')
INSERT INTO HOCVIEN VALUES('K1211',N'Đỗ Thị',N'Xuân','9/3/1986',N'Nữ',N'Hà Nội','K12')
INSERT INTO HOCVIEN VALUES('K1212',N'Lê Thị Phi',N'Yến','12/3/1986',N'Nữ',N'TpHCM','K12')
INSERT INTO HOCVIEN VALUES('K1301',N'Nguyễn Thị Kim',N'Cúc','9/6/1986',N'Nữ',N'Kiên Giang','K13')
INSERT INTO HOCVIEN VALUES('K1302',N'Trương Thị Mỹ',N'Hiền','18/3/1986',N'Nữ',N'Nghệ An','K13')
INSERT INTO HOCVIEN VALUES('K1303',N'Lê Đức',N'Hiền','21/3/1986',N'Nam',N'Tây Ninh','K13')
INSERT INTO HOCVIEN VALUES('K1304',N'Lê Quang',N'Hiền','18/4/1986',N'Nam',N'TpHCM','K13')
INSERT INTO HOCVIEN VALUES('K1305',N'Lê Thị',N'Hương','27/3/1986',N'Nữ',N'TpHCM','K13')
INSERT INTO HOCVIEN VALUES('K1306',N'Nguyễn Thái',N'Hữu','30/3/1986',N'Nam',N'Ha Noi','K13')
INSERT INTO HOCVIEN VALUES('K1307',N'Trần Minh',N'Mẫn','28/5/1986',N'Nam',N'TpHCM','K13')
INSERT INTO HOCVIEN VALUES('K1308',N'Nguyễn Hiếu',N'Nghĩa','8/4/1986',N'Nam',N'Kiên Giang','K13')
INSERT INTO HOCVIEN VALUES('K1309',N'Nguyễn Trung',N'Nghĩa','18/1/1987',N'Nam',N'Nghệ An','K13')
INSERT INTO HOCVIEN VALUES('K1310',N'Trần Thị Hồng',N'Thăm','22/4/1986',N'Nữ',N'Tây Ninh','K13')
INSERT INTO HOCVIEN VALUES('K1311',N'Trần Minh',N'Thức','4/4/1986',N'Nam',N'TpHCM','K13')
INSERT INTO HOCVIEN VALUES('K1312',N'Nguyễn Thị Kim',N'Yến','7/9/1986',N'Nữ',N'TpHCM','K13')

--Thêm dữ liệu vào bảng kết quả thi

INSERT INTO KETQUATHI VALUES('K1101','CSDL',1,'20/7/2006',10,N'Đạt')
INSERT INTO KETQUATHI VALUES('K1101','CTDLGT',1,'28/12/2006',9,N'Đạt')
INSERT INTO KETQUATHI VALUES('K1101','THDC',1,'20/5/2006',9,N'Đạt')
INSERT INTO KETQUATHI VALUES('K1101','CTRR',1,'13/5/2006',9.5,N'Đạt')
INSERT INTO KETQUATHI VALUES('K1102','CSDL',1,'20/7/2006',4,N'Không Đạt')
INSERT INTO KETQUATHI VALUES('K1102','CSDL',2,'27/7/2006',4.25,N'Không Đạt')
INSERT INTO KETQUATHI VALUES('K1102','CSDL',3,'10/8/2006',4.5,N'Không Đạt')
INSERT INTO KETQUATHI VALUES('K1102','CTDLGT',1,'28/12/2006',4.5,N'Không Đạt')
INSERT INTO KETQUATHI VALUES('K1102','CTDLGT',2,'5/1/2007',4,N'Không Đạt')
INSERT INTO KETQUATHI VALUES('K1102','CTDLGT',3,'15/1/2007',6,N'Đạt')
INSERT INTO KETQUATHI VALUES('K1102','THDC',1,'20/5/2006',5,N'Đạt')
INSERT INTO KETQUATHI VALUES('K1102','CTRR',1,'13/5/2006',7,N'Đạt')
INSERT INTO KETQUATHI VALUES('K1103','CSDL',1,'20/7/2006',3.5,N'Không Đạt')
INSERT INTO KETQUATHI VALUES('K1103','CSDL',2,'27/7/2006',8.25,N'Đạt')
INSERT INTO KETQUATHI VALUES('K1103','CTDLGT',1,'28/12/2006',7,N'Đạt')
INSERT INTO KETQUATHI VALUES('K1103','THDC',1,'20/5/2006',8,N'Đạt')
INSERT INTO KETQUATHI VALUES('K1103','CTRR',1,'13/5/2006',6.5,N'Đạt')
INSERT INTO KETQUATHI VALUES('K1104','CSDL',1,'20/7/2006',3.75,N'Không Đạt')
INSERT INTO KETQUATHI VALUES('K1104','CTDLGT',1,'28/12/2006',4,N'Không Đạt')
INSERT INTO KETQUATHI VALUES('K1104','THDC',1,'20/5/2006',4,N'Không Đạt')
INSERT INTO KETQUATHI VALUES('K1104','CTRR',1,'13/5/2006',4,N'Không Đạt')
INSERT INTO KETQUATHI VALUES('K1104','CTRR',2,'20/5/2006',3.5,N'Không Đạt')
INSERT INTO KETQUATHI VALUES('K1104','CTRR',3,'30/6/2006',4,N'Không Đạt')
INSERT INTO KETQUATHI VALUES('K1201','CSDL',1,'20/7/2006',6,N'Đạt')
INSERT INTO KETQUATHI VALUES('K1201','CTDLGT',1,'28/12/2006',5,N'Đạt')
INSERT INTO KETQUATHI VALUES('K1201','THDC',1,'20/5/2006',8.5,'Đạt')
INSERT INTO KETQUATHI VALUES('K1201','CTRR',1,'13/5/2006',9,N'Đạt')
INSERT INTO KETQUATHI VALUES('K1202','CSDL',1,'20/7/2006',8,N'Đạt')
INSERT INTO KETQUATHI VALUES('K1202','CTDLGT',1,'28/12/2006',4,N'Không Đạt')
INSERT INTO KETQUATHI VALUES('K1202','CTDLGT',2,'5/1/2007',5,N'Đạt')
INSERT INTO KETQUATHI VALUES('K1202','THDC',1,'20/5/2006',4,N'Không Đạt')
INSERT INTO KETQUATHI VALUES('K1202','THDC',2,'27/5/2006',4,N'Không Đạt')
INSERT INTO KETQUATHI VALUES('K1202','CTRR',1,'13/5/2006',3,N'Không Đạt')
INSERT INTO KETQUATHI VALUES('K1202','CTRR',2,'20/5/2006',4,N'Không Đạt')
INSERT INTO KETQUATHI VALUES('K1202','CTRR',3,'30/6/2006',6.25,N'Đạt')
INSERT INTO KETQUATHI VALUES('K1203','CSDL',1,'20/7/2006',9.25,N'Đạt')
INSERT INTO KETQUATHI VALUES('K1203','CTDLGT',1,'28/12/2006',9.5,N'Đạt')
INSERT INTO KETQUATHI VALUES('K1203','THDC',1,'20/5/2006',10,N'Đạt')
INSERT INTO KETQUATHI VALUES('K1203','CTRR',1,'13/5/2006',10,N'Đạt')
INSERT INTO KETQUATHI VALUES('K1204','CSDL',1,'20/7/2006',8.5,N'Đạt')
INSERT INTO KETQUATHI VALUES('K1204','CTDLGT',1,'28/12/2006',6.75,N'Đạt')
INSERT INTO KETQUATHI VALUES('K1204','THDC',1,'20/5/2006',4,N'Không Đạt')
INSERT INTO KETQUATHI VALUES('K1204','CTRR',1,'13/5/2006',6,N'Đạt')
INSERT INTO KETQUATHI VALUES('K1301','CSDL',1,'20/12/2006',4.25,N'Không Đạt')
INSERT INTO KETQUATHI VALUES('K1301','CTDLGT',1,'25/7/2006',8,N'Đạt')
INSERT INTO KETQUATHI VALUES('K1301','THDC',1,'20/5/2006',7.75,N'Đạt')
INSERT INTO KETQUATHI VALUES('K1301','CTRR',1,'13/5/2006',8,N'Đạt')
INSERT INTO KETQUATHI VALUES('K1302','CSDL',1,'20/12/2006',6.75,N'Đạt')
INSERT INTO KETQUATHI VALUES('K1302','CTDLGT',1,'25/7/2006',5,N'Đạt')
INSERT INTO KETQUATHI VALUES('K1302','THDC',1,'20/5/2006',8,N'Đạt')
INSERT INTO KETQUATHI VALUES('K1302','CTRR',1,'13/5/2006',8.5,N'Đạt')
INSERT INTO KETQUATHI VALUES('K1303','CSDL',1,'20/12/2006',4,N'Không Đạt')
INSERT INTO KETQUATHI VALUES('K1303','CTDLGT',1,'25/7/2006',4.5,N'Không Đạt')
INSERT INTO KETQUATHI VALUES('K1303','CTDLGT',2,'7/8/2006',4,N'Không Đạt')
INSERT INTO KETQUATHI VALUES('K1303','CTDLGT',3,'15/8/2006',4.25,N'Không Đạt')
INSERT INTO KETQUATHI VALUES('K1303','THDC',1,'20/5/2006',4.5,N'Không Đạt')
INSERT INTO KETQUATHI VALUES('K1303','CTRR',1,'13/5/2006',3.25,N'Không Đạt')
INSERT INTO KETQUATHI VALUES('K1303','CTRR',2,'20/5/2006',5,N'Đạt')
INSERT INTO KETQUATHI VALUES('K1304','CSDL',1,'20/12/2006',7.75,N'Đạt')
INSERT INTO KETQUATHI VALUES('K1304','CTDLGT',1,'25/7/2006',9.75,N'Đạt')
INSERT INTO KETQUATHI VALUES('K1304','THDC',1,'20/5/2006',5.5,N'Đạt')
INSERT INTO KETQUATHI VALUES('K1304','CTRR',1,'13/5/2006',5,N'Đạt')
INSERT INTO KETQUATHI VALUES('K1305','CSDL',1,'20/12/2006',9.25,N'Đạt')
INSERT INTO KETQUATHI VALUES('K1305','CTDLGT',1,'25/7/2006',10,N'Đạt')
INSERT INTO KETQUATHI VALUES('K1305','THDC',1,'20/5/2006',8,N'Đạt')
INSERT INTO KETQUATHI VALUES('K1305','CTRR',1,'13/5/2006',10,N'Đạt')

--Tạo khóa ngoại cho các bảng

ALTER TABLE KHOA ADD CONSTRAINT FK_TRGKHOA_KHOA FOREIGN KEY(TRGKHOA) REFERENCES GIAOVIEN(MAGV);

ALTER TABLE MONHOC ADD CONSTRAINT FK_MAKHOA_MONHOC FOREIGN KEY(MAKHOA) REFERENCES KHOA(MAKHOA);

ALTER TABLE DIEUKIEN ADD CONSTRAINT FK_MAMH_DIEUKIEN FOREIGN KEY(MAMH) REFERENCES MONHOC(MAMH);
ALTER TABLE DIEUKIEN ADD CONSTRAINT FK_MAMH_TRUOC_DIEUKIEN FOREIGN KEY(MAMH_TRUOC) REFERENCES MONHOC(MAMH);

ALTER TABLE GIAOVIEN ADD CONSTRAINT FK_MAKHOA_GIAOVIEN FOREIGN KEY(MAKHOA) REFERENCES KHOA(MAKHOA);

ALTER TABLE LOP ADD CONSTRAINT FK_TRGLOP_LOP FOREIGN KEY(TRGLOP) REFERENCES HOCVIEN(MAHV);
ALTER TABLE LOP ADD CONSTRAINT FK_MAGVCN_LOP FOREIGN KEY(MAGVCN) REFERENCES GIAOVIEN(MAGV);

ALTER TABLE HOCVIEN ADD CONSTRAINT FK_MALOP_HOCVIEN FOREIGN KEY(MALOP) REFERENCES LOP(MALOP);

ALTER TABLE GIANGDAY ADD CONSTRAINT FK_MALOP_GIANGDAY FOREIGN KEY(MALOP) REFERENCES LOP(MALOP);
ALTER TABLE GIANGDAY ADD CONSTRAINT FK_MAMH_GIANGDAY FOREIGN KEY(MAMH) REFERENCES MONHOC(MAMH); 

ALTER TABLE KETQUATHI ADD CONSTRAINT FK_MAHV_KETQUATHI FOREIGN KEY(MAHV) REFERENCES HOCVIEN(MAHV);
ALTER TABLE KETQUATHI ADD CONSTRAINT FK_MAMH_KETQUATHI FOREIGN KEY(MAMH) REFERENCES MONHOC(MAMH);

--Thêm vào 3 thuộc tính GHICHU, DIEMTB, XEPLOAI cho quan hệ HOCVIEN

ALTER TABLE HOCVIEN	ADD GHICHU NVARCHAR(100);
ALTER TABLE HOCVIEN	ADD DIEMTB NUMERIC(4, 2);
ALTER TABLE HOCVIEN	ADD XEPLOAI NVARCHAR(10);

/*
Câu 2:
Mã học viên là một chuỗi 5 ký tự, 3 ký tự đầu là mã lớp, 
2 ký tự cuối cùng là số thứ tự học viên trong lớp. VD: “K1101”
*/

ALTER TABLE HOCVIEN ADD CONSTRAINT CHK_MAHV_HOCVIEN CHECK(SUBSTRING(MAHV, 1,3) = MALOP AND ISNUMERIC(SUBSTRING(MAHV, 4, 2)) = 1);

/*
Câu 3:
Thuộc tính GIOITINH chỉ có giá trị là “Nam” hoặc “Nu”.
*/

ALTER TABLE HOCVIEN ADD CONSTRAINT CHK_GIOITINH_HOCVIEN CHECK(GIOITINH IN (N'NAM', N'NỮ'));

ALTER TABLE GIAOVIEN ADD CONSTRAINT CHK_GIOITINH_GIAOVIEN CHECK(GIOITINH IN (N'NAM',N'NỮ'));

/*
Câu 4:
Điểm số của một lần thi có giá trị từ 0 đến 10 
và cần lưu đến 2 số lẽ (VD: 6.22).
*/

ALTER TABLE KETQUATHI ADD CONSTRAINT CHK_DIEM_KETQUATHI CHECK(DIEM BETWEEN 0 AND 10);

--Buổi 2-----------------------------------------------------------------------------------------------------------------------------
/*Phần 2 câu 1:
Tăng hệ số lương thêm 0.2 cho những giáo viên là trưởng khoa.
*/

UPDATE GIAOVIEN SET HESO = HESO + 0.2 WHERE MAGV IN (SELECT TRGKHOA FROM KHOA);

/*Phần 2 câu 2:
Cập nhật giá trị điểm trung bình tất cả các môn học (DIEMTB) của mỗi học viên (tất cả các
môn học đều có hệ số 1 và nếu học viên thi một môn nhiều lần, chỉ lấy điểm của lần thi sau
cùng).
*/

UPDATE HOCVIEN SET DIEMTB = (
	SELECT AVG(DIEM) FROM KETQUATHI WHERE LANTHI = (
	SELECT MAX(LANTHI) FROM KETQUATHI KQ WHERE MAHV = KETQUATHI.MAHV GROUP BY MAHV
	) GROUP BY MAHV HAVING MAHV = HOCVIEN.MAHV
);

/*Phần 2 câu 3:
Cập nhật giá trị cho cột GHICHU là “Cam thi” đối với trường hợp: 
học viên có một môn bất kỳ thi lần thứ 3 dưới 5 điểm.
*/

--Cách 1
UPDATE HOCVIEN SET GHICHU = N'Cấm thi' WHERE MAHV IN (
	SELECT MAHV FROM KETQUATHI WHERE LANTHI = 3 AND DIEM < 5
);

--Cách 2
UPDATE HOCVIEN SET GHICHU = N'Cấm thi' WHERE EXISTS (
	SELECT * FROM KETQUATHI	WHERE MAHV = HOCVIEN.MAHV AND LANTHI = 3 AND DIEM < 5 
);

/*
Phần 2 câu 4:
Cập nhật giá trị cho cột XEPLOAI trong quan hệ HOCVIEN như sau:
Nếu DIEMTB >= 9 thì XEPLOAI =”XS”
Nếu 8 <= DIEMTB < 9 thì XEPLOAI = “G”
Nếu 6.5 <= DIEMTB < 8 thì XEPLOAI = “K”
Nếu 5 <= DIEMTB < 6.5 thì XEPLOAI = “TB”
Nếu DIEMTB <= 5 thì XEPLOAI = ”Y”
*/

UPDATE HOCVIEN SET XEPLOAI = (
	CASE
	WHEN DIEMTB >= 9 THEN N'XUẤT SẮC'
	WHEN DIEMTB >= 8 AND DIEMTB < 9 THEN N'GIỎI'
	WHEN DIEMTB >= 6.5 AND DIEMTB < 8 THEN N'KHÁ'
	WHEN DIEMTB >= 5 AND DIEMTB < 6.5 THEN N'TRUNG BÌNH'
	WHEN DIEMTB < 5 THEN N'YẾU'
	END
);

/*
Phần 3 câu 1:
In ra danh sách (mã học viên, họ tên, ngày sinh, mã lớp) lớp trưởng của các lớp.
*/

--Cách 1
SELECT HOCVIEN.MAHV, (HO + ' ' + TEN) HOTEN, HOCVIEN.NGSINH, HOCVIEN.MALOP
FROM HOCVIEN, LOP
WHERE HOCVIEN.MAHV = LOP.TRGLOP

--Cách 2
SELECT HOCVIEN.MAHV, CONCAT(HO,' ',TEN) HOTEN, HOCVIEN.NGSINH, HOCVIEN.MALOP
FROM HOCVIEN, LOP
WHERE HOCVIEN.MAHV = LOP.TRGLOP

--Cách 3
SELECT HOCVIEN.MAHV, (HO + ' ' + TEN) HOTEN, HOCVIEN.NGSINH, HOCVIEN.MALOP
FROM LOP INNER JOIN HOCVIEN 
ON HOCVIEN.MAHV = LOP.TRGLOP 

--Cách 4
SELECT HOCVIEN.MAHV, (HO + ' ' + TEN) HOTEN, HOCVIEN.NGSINH, HOCVIEN.MALOP
FROM HOCVIEN, LOP
WHERE HOCVIEN.MAHV = LOP.TRGLOP AND MAHV IN (
	SELECT TRGLOP 
	FROM LOP INNER JOIN HOCVIEN 
	ON HOCVIEN.MAHV = LOP.TRGLOP
)

--Cách 5
SELECT HOCVIEN.MAHV, (HO + ' ' + TEN) HOTEN, HOCVIEN.NGSINH, HOCVIEN.MALOP
FROM HOCVIEN, LOP
WHERE MAHV IN (SELECT TRGLOP FROM LOP) AND HOCVIEN.MAHV = LOP.TRGLOP

/*
Phần 3 câu 2:
In ra bảng điểm khi thi (mã học viên, họ tên , lần thi, điểm số) môn CTRR của lớp “K12”,
sắp xếp theo tên, họ học viên.
*/

--Cách 1
SELECT HOCVIEN.MAHV, (HO + ' ' + TEN) HOTEN, KETQUATHI.LANTHI, KETQUATHI.DIEM
FROM KETQUATHI, HOCVIEN
WHERE KETQUATHI.MAHV = HOCVIEN.MAHV AND MAMH = 'CTRR' AND MALOP = 'K12'
ORDER BY TEN, HO

--Cách 2
SELECT HOCVIEN.MAHV, CONCAT(HO,' ',TEN) HOTEN, KETQUATHI.LANTHI, KETQUATHI.DIEM
FROM KETQUATHI, HOCVIEN
WHERE KETQUATHI.MAHV = HOCVIEN.MAHV AND MAMH = 'CTRR' AND MALOP = 'K12'
ORDER BY TEN, HO

--Cách 3
SELECT HOCVIEN.MAHV, (HO + ' ' + TEN) HOTEN, HOCVIEN.NGSINH, HOCVIEN.MALOP
FROM HOCVIEN INNER JOIN KETQUATHI 
ON KETQUATHI.MAHV = HOCVIEN.MAHV AND  MAMH = 'CTRR' AND MALOP = 'K12'
ORDER BY TEN, HO

--Cách 4
SELECT HOCVIEN.MAHV, (HO + ' ' + TEN) HOTEN, HOCVIEN.NGSINH, HOCVIEN.MALOP
FROM HOCVIEN, KETQUATHI
WHERE MAMH IN (SELECT 'CTRR' FROM KETQUATHI) AND KETQUATHI.MAHV = HOCVIEN.MAHV AND MALOP IN (SELECT 'K12' FROM KETQUATHI)
ORDER BY TEN, HO

/*
Phần 3 câu 3: 
In ra danh sách những học viên (mã học viên, họ tên) và những môn học mà học viên đó thi
lần thứ nhất đã đạt.
*/

--Cách 1
SELECT HOCVIEN.MAHV, (HO + ' ' + TEN) HOTEN, MONHOC.TENMH, KETQUATHI.KQUA, KETQUATHI.LANTHI
FROM KETQUATHI, HOCVIEN, MONHOC
WHERE KETQUATHI.MAHV = HOCVIEN.MAHV AND LANTHI = 1 AND KQUA = 'Đạt' AND MONHOC.MAMH = KETQUATHI.MAMH

--Cách 2
SELECT HOCVIEN.MAHV, CONCAT(HO,' ',TEN) HOTEN, MONHOC.TENMH, KETQUATHI.KQUA, KETQUATHI.LANTHI
FROM KETQUATHI, HOCVIEN, MONHOC
WHERE KETQUATHI.MAHV = HOCVIEN.MAHV AND LANTHI = 1 AND KQUA = 'Đạt' AND MONHOC.MAMH = KETQUATHI.MAMH 

--Cách 3
SELECT HOCVIEN.MAHV, (HO + ' ' + TEN) HOTEN, MONHOC.TENMH, KETQUATHI.KQUA, KETQUATHI.LANTHI
FROM KETQUATHI, HOCVIEN, MONHOC
WHERE LANTHI IN (SELECT 1 FROM KETQUATHI) AND KQUA IN (SELECT 'Đạt' FROM KETQUATHI) AND KETQUATHI.MAHV = HOCVIEN.MAHV AND MONHOC.MAMH = KETQUATHI.MAMH
ORDER BY TEN, HO

/*
Phần 3 câu 4: 
In ra danh sách học viên (mã học viên, họ tên) của lớp “K11” thi môn CTRR không đạt (ở
lần thi 1).
*/

--Cách 1
SELECT HOCVIEN.MAHV, (HO + ' ' + TEN) HOTEN
FROM KETQUATHI, HOCVIEN
WHERE KETQUATHI.MAHV = HOCVIEN.MAHV AND MALOP = 'K11' AND MAMH = 'CTRR' AND KQUA = 'Không Đạt' AND LANTHI = 1

--Cách 2
SELECT HOCVIEN.MAHV, CONCAT(HO,' ',TEN) HOTEN
FROM KETQUATHI, HOCVIEN
WHERE KETQUATHI.MAHV = HOCVIEN.MAHV AND MALOP = 'K11' AND MAMH = 'CTRR' AND KQUA = 'Không Đạt' AND LANTHI = 1

--Cách 3
SELECT HOCVIEN.MAHV, (HO + ' ' + TEN) HOTEN
FROM KETQUATHI, HOCVIEN
WHERE MALOP IN (SELECT 'K11' FROM HOCVIEN) AND MAMH IN (SELECT 'CTRR' FROM KETQUATHI) 
  AND KQUA IN (SELECT 'Không Đạt' FROM KETQUATHI) AND LANTHI IN (SELECT 1 FROM KETQUATHI)
  AND KETQUATHI.MAHV = HOCVIEN.MAHV
ORDER BY TEN, HO


--Câu 5 phần 3
/*Danh sách học viên (mã học viên, họ tên) của lớp “K” thi môn CTRR không đạt (ở tất cả
các lần thi).*/

--CÁCH 1

SELECT DISTINCT HOCVIEN.MAHV, (HO+' '+TEN) HOTEN
FROM HOCVIEN, KETQUATHI
WHERE
	HOCVIEN.MAHV = KETQUATHI.MAHV
	AND MALOP LIKE 'K%'
	AND MAMH = 'CTRR'
	AND NOT EXISTS (
	SELECT * FROM KETQUATHI 
		WHERE 
			KQUA = 'Đạt' 
			AND MAMH = 'CTRR' 
			AND MAHV = HOCVIEN.MAHV
	)

--CÁCH 2

SELECT HOCVIEN.MAHV, (HO+' '+TEN) HOTEN
FROM HOCVIEN JOIN KETQUATHI ON HOCVIEN.MAHV = KETQUATHI.MAHV
WHERE 
	KETQUATHI.KQUA = 'Không Đạt' 
	AND MAMH = 'CTRR'
	AND SUBSTRING(HOCVIEN.MAHV, 1, 1) = 'K'
	AND NOT EXISTS (
		SELECT * 
		FROM KETQUATHI
		WHERE
			HOCVIEN.MAHV = KETQUATHI.MAHV
			AND KQUA = 'Đạt'
	)
	
--Câu 6 phần 3
/*Tìm tên những môn học mà giáo viên có tên “Tran Tam Thanh” dạy trong học kỳ 1 năm
2006.*/

SELECT DISTINCT TENMH
FROM MONHOC, GIAOVIEN, GIANGDAY
WHERE
	MONHOC.MAKHOA = GIANGDAY.MAMH
	AND GIAOVIEN.MAGV = GIANGDAY.MAGV
	AND HOTEN = 'Trần Tâm Thanh'
	AND HOCKY = 1
	AND NAM = 2006

--CÁCH 2

SELECT TENMH
FROM MONHOC JOIN GIANGDAY
ON MONHOC.MAMH = GIANGDAY.MAMH JOIN GIAOVIEN ON GIANGDAY.MAGV = GIAOVIEN.MAGV
WHERE 
	HOTEN = 'Trần Tâm Thanh'
	AND HOCKY = 1
	AND NAM = 2006

--CÁCH 3

SELECT MONHOC.TENMH
FROM MONHOC JOIN GIANGDAY 
ON MONHOC.MAMH = GIANGDAY.MAMH JOIN GIAOVIEN ON GIAOVIEN.MAGV = GIANGDAY.MAGV
WHERE
	GIAOVIEN.HOTEN = 'Trần Tâm Thanh'
	AND HOCKY = 1
	AND NAM = 2006

--Câu 7 phần 3
/*Tìm những môn học (mã môn học, tên môn học) mà giáo viên chủ nhiệm lớp “K11” dạy
trong học kỳ 1 năm 2006.*/

--CÁCH 1

SELECT DISTINCT	MONHOC.MAMH, TENMH
FROM MONHOC, LOP, GIANGDAY
WHERE
	GIANGDAY.MAMH = MONHOC.MAMH
	AND GIANGDAY.MAGV = LOP.MAGVCN
	AND LOP.MALOP = 'K11'
	AND HOCKY = 1 AND NAM = 2006

--CÁCH 2

SELECT MONHOC.MAMH, TENMH
FROM LOP JOIN GIANGDAY 
ON LOP.MAGVCN = GIANGDAY.MAGV JOIN MONHOC ON MONHOC.MAMH = GIANGDAY.MAMH
WHERE
	LOP.MALOP = 'K11'
	AND HOCKY = 1
	AND NAM = 2006

--CÁCH 3

SELECT DISTINCT GIANGDAY.MAMH, TENMH
FROM GIANGDAY
INNER JOIN LOP ON GIANGDAY.MAGV = LOP.MAGVCN
INNER JOIN MONHOC ON GIANGDAY.MAMH = MONHOC.MAMH
WHERE
	NAM = 2006
	AND HOCKY = 1
	AND MAGV IN(
		SELECT MAGVCN
		FROM LOP
		WHERE MALOP = 'K11'
	)

--Câu 8 phần 3
/*Tìm họ tên lớp trưởng của các lớp mà giáo viên có tên “Nguyen To Lan” dạy môn “Co So
Du Lieu”.*/

--CÁCH 1

SELECT DISTINCT (HO + ' ' + TEN) HOTEN
FROM HOCVIEN, LOP, GIAOVIEN, GIANGDAY, MONHOC
WHERE
	LOP.TRGLOP = HOCVIEN.MAHV
	AND GIANGDAY.MALOP = LOP.MALOP
	AND GIANGDAY.MAGV = GIAOVIEN.MAGV
	AND GIANGDAY.MAMH = MONHOC.MAMH
	AND HOTEN = N'Nguyễn Tô Lan'
	AND TENMH = N'Cơ Sở Dữ Liệu'

--CÁCH 2

SELECT (HO + ' ' + TEN) HOTEN
FROM LOP
INNER JOIN HOCVIEN ON LOP.TRGLOP = HOCVIEN.MAHV
INNER JOIN GIANGDAY ON GIANGDAY.MALOP = LOP.MALOP
WHERE
	MAGV IN (
		SELECT MAGV 
		FROM GIAOVIEN
		WHERE HOTEN = 'Nguyễn Tô Lan'
	)
	AND MAMH IN(
		SELECT MAMH
		FROM MONHOC
		WHERE TENMH = 'Cơ Sở Dữ Liệu'
	)

--Câu 9 phần 3
/*In ra danh sách những môn học (mã môn học, tên môn học) phải học liền trước môn “Co So
Du Lieu”.*/

--CÁCH 1

SELECT MONHOCTRUOC.MAMH, MONHOCTRUOC.TENMH
FROM MONHOC, MONHOC AS MONHOCTRUOC, DIEUKIEN
WHERE
	MONHOC.MAMH = DIEUKIEN.MAMH
	AND MONHOCTRUOC.MAMH = DIEUKIEN.MAMH_TRUOC
	AND MONHOC.TENMH = N'Cơ Sở Dữ Liệu'

--CÁCH 2

SELECT MONHOC.MAMH, TENMH
FROM MONHOC JOIN DIEUKIEN 
ON MONHOC.MAMH = DIEUKIEN.MAMH_TRUOC
WHERE
	DIEUKIEN.MAMH_TRUOC = (
		SELECT MAMH
		FROM MONHOC
		WHERE TENMH = 'Cơ Sở Dữ Liệu'
	)

--Câu 10 phần 3
/*Môn “Cau Truc Roi Rac” là môn bắt buộc phải học liền trước những môn học (mã môn học,
tên môn học) nào.*/

--CÁCH 1

SELECT MONHOC.MAMH, MONHOC.TENMH
FROM MONHOC, MONHOC AS MONHOCTRUOC, DIEUKIEN
WHERE
	MONHOC.MAMH = DIEUKIEN.MAMH
	AND MONHOCTRUOC.MAMH = DIEUKIEN.MAMH_TRUOC
	AND MONHOCTRUOC.TENMH = N'Cơ Sở Dữ Liệu'

--CÁCH 2

SELECT MONHOC.MAMH, TENMH
FROM MONHOC JOIN DIEUKIEN 
ON MONHOC.MAMH = DIEUKIEN.MAMH_TRUOC
WHERE
	DIEUKIEN.MAMH_TRUOC = (
		SELECT MAMH
		FROM MONHOC
		WHERE MONHOC.TENMH = 'Cơ Sở Dữ Liệu'
	)

--CÂU 11 PHẦN 3
/*Tìm họ tên giáo viên dạy môn CTRR cho cả hai lớp “K11” và “K12” trong cùng học kỳ 1
năm 2006.*/

--CÁCH 1

SELECT HOTEN
FROM GIAOVIEN, GIANGDAY
WHERE
	GIAOVIEN.MAGV = GIANGDAY.MAGV
	AND MALOP = 'K11'
	AND HOCKY = 1 
	AND NAM = 2006
	AND MAMH = 'CTRR'
INTERSECT 
	(SELECT HOTEN
	FROM GIAOVIEN, GIANGDAY
	WHERE
		GIAOVIEN.MAGV = GIANGDAY.MAGV
		AND MALOP = 'K12' 
		AND HOCKY = 1 
		AND NAM = 2006
		AND MAMH = 'CTRR')

--CÁCH 2

SELECT HOTEN
FROM GIAOVIEN
WHERE MAGV IN (
	SELECT MAGV
	FROM GIANGDAY
	WHERE 
		MALOP = 'K12' 
		AND HOCKY = 1 
		AND NAM = 2006
		AND MAMH = 'CTRR'
)
INTERSECT
SELECT HOTEN
FROM GIAOVIEN
WHERE MAGV IN (
	SELECT MAGV
	FROM GIANGDAY
	WHERE 
		MALOP = 'K11' 
		AND HOCKY = 1 
		AND NAM = 2006
		AND MAMH = 'CTRR'
)


--CÂU 12 PHẦN 3
/*Tìm những học viên (mã học viên, họ tên) thi không đạt môn CSDL ở lần thi thứ 1 nhưng
chưa thi lại môn này.*/
--CÁCH 1

SELECT HOCVIEN.MAHV, (HO + ' ' + TEN) HOTEN
FROM HOCVIEN, KETQUATHI
WHERE
	HOCVIEN.MAHV = KETQUATHI.MAHV
	AND MAMH = 'CSDL' AND LANTHI = 1 AND KQUA = N'Không Đạt'
EXCEPT (
	SELECT HOCVIEN.MAHV, (HO + ' ' + TEN) HOTEN
	FROM HOCVIEN, KETQUATHI
	WHERE
		HOCVIEN.MAHV = KETQUATHI.MAHV
		AND MAMH = 'CSDL' AND LANTHI >= 2 AND KQUA = N'Đạt'
)

--CÁCH 2

SELECT HOCVIEN.MAHV, (HO + ' ' + TEN) HOTEN
FROM HOCVIEN
WHERE 
	MAHV IN(
		SELECT MAHV
		FROM KETQUATHI
		WHERE 
			MAMH = 'CSDL'
			AND LANTHI = 1
			AND KQUA = 'Không Đạt'
	)
EXCEPT
SELECT HOCVIEN.MAHV, (HO + ' ' + TEN) HOTEN
FROM HOCVIEN
WHERE 
	MAHV IN(
		SELECT MAHV
		FROM KETQUATHI
		WHERE 
			MAMH = 'CSDL'
			AND LANTHI > 1
			AND KQUA = 'Đạt'
	)

--CÂU 13 PHẦN 3
/*Tìm giáo viên (mã giáo viên, họ tên) không được phân công giảng dạy bất kỳ môn học nào.*/

--CÁCH 1

SELECT MAGV, HOTEN
FROM GIAOVIEN
WHERE MAGV NOT IN (SELECT MAGV FROM GIANGDAY)

--CÁCH 2

SELECT MAGV, HOTEN
FROM GIAOVIEN
EXCEPT 
SELECT DISTINCT GIANGDAY.MAGV, HOTEN
FROM GIANGDAY JOIN GIAOVIEN
ON  GIAOVIEN.MAGV = GIANGDAY.MAGV

--CÂU 14 PHẦN 3
/*Tìm giáo viên (mã giáo viên, họ tên) không được phân công giảng dạy bất kỳ môn học nào
thuộc khoa giáo viên đó phụ trách.*/

--CÁCH 1

SELECT MAGV, HOTEN
FROM GIAOVIEN
WHERE NOT EXISTS(
	SELECT * 
	FROM MONHOC
	WHERE MONHOC.MAKHOA = GIAOVIEN.MAKHOA
	AND NOT EXISTS(
		SELECT * 
		FROM GIANGDAY
		WHERE GIANGDAY.MAMH = MONHOC.MAMH
		AND GIANGDAY.MAGV = GIAOVIEN.MAGV
	)
)

--CÁCH 2

SELECT GIAOVIEN.MAGV, HOTEN
FROM GIAOVIEN
WHERE MAGV NOT IN (
	SELECT MAGV
	FROM GIANGDAY JOIN MONHOC 
	ON GIANGDAY.MAMH = MONHOC.MAMH
	WHERE GIAOVIEN.MAKHOA = MONHOC.MAKHOA
)

--CÂU 15 PHẦN 3
/*Tìm họ tên các học viên thuộc lớp “K11” thi một môn bất kỳ quá 3 lần vẫn “Khong dat”
hoặc thi lần thứ 2 môn CTRR được 5 điểm.*/

--CÁCH 1

SELECT DISTINCT (HO + ' ' + TEN) HOTEN
FROM HOCVIEN, KETQUATHI
WHERE
	HOCVIEN.MAHV = KETQUATHI.MAHV
	AND MALOP = 'K11'
	AND (
	(LANTHI = 2 AND DIEM = 5)
	OR HOCVIEN.MAHV 
	IN 
		(
			SELECT DISTINCT MAHV
			FROM KETQUATHI
			WHERE KQUA = N'Không Đạt'
			GROUP BY MAHV, MAMH
			HAVING COUNT(*) > 3
		)
	)

--CÁCH 2

SELECT DISTINCT (HO + ' ' + TEN) HOTEN
FROM HOCVIEN
INNER JOIN KETQUATHI
ON HOCVIEN.MAHV = KETQUATHI.MAHV
WHERE
	HOCVIEN.MAHV = KETQUATHI.MAHV
	AND MALOP = 'K11'
	AND (
	(LANTHI = 2 AND DIEM = 5)
	OR HOCVIEN.MAHV 
	IN 
		(
			SELECT DISTINCT MAHV
			FROM KETQUATHI
			WHERE KQUA = N'Không Đạt'
			GROUP BY MAHV, MAMH
			HAVING COUNT(*) > 3
		)
	)

--CÂU 16 PHẦN 3
/*Tìm họ tên giáo viên dạy môn CTRR cho ít nhất hai lớp trong cùng một học kỳ của một năm
học.*/

--CÁCH 1

SELECT HOTEN
FROM GIAOVIEN, GIANGDAY
WHERE
	GIAOVIEN.MAGV = GIANGDAY.MAGV
	AND MAMH = 'CTRR'
GROUP BY GIAOVIEN.MAGV, HOTEN, HOCKY
HAVING COUNT(*) >= 2

--CÁCH 2

SELECT HOTEN
FROM GIAOVIEN
INNER JOIN GIANGDAY
ON GIAOVIEN.MAGV = GIANGDAY.MAGV
WHERE
	MAMH = 'CTRR'
GROUP BY GIAOVIEN.MAGV, HOTEN, HOCKY
HAVING COUNT(*) >= 2

--CÂU 17 PHẦN 3
/*Danh sách học viên và điểm thi môn CSDL (chỉ lấy điểm của lần thi sau cùng).*/

--CÁCH 1

SELECT HOCVIEN.*, DIEM AS 'Điểm thi CSDL sau cùng'
FROM HOCVIEN, KETQUATHI
WHERE
	HOCVIEN.MAHV = KETQUATHI.MAHV
	AND MAMH = 'CSDL'
	AND LANTHI = 
	(
		SELECT MAX(LANTHI) 
		FROM KETQUATHI 
		WHERE 
			MAMH = 'CSDL' 
			AND KETQUATHI.MAHV = HOCVIEN.MAHV 
		GROUP BY MAHV
	)

--CÁCH 2

SELECT HOCVIEN.*, DIEM AS 'Điểm thi CSDL sau cùng'
FROM HOCVIEN
INNER JOIN KETQUATHI 
ON HOCVIEN.MAHV = KETQUATHI.MAHV
WHERE
	MAMH = 'CSDL'
	AND LANTHI = 
	(
		SELECT MAX(LANTHI) 
		FROM KETQUATHI 
		WHERE 
			MAMH = 'CSDL' 
			AND KETQUATHI.MAHV = HOCVIEN.MAHV 
		GROUP BY MAHV
	)
--CÂU 18 PHẦN 3
/*Danh sách học viên và điểm thi môn “Co So Du Lieu” (chỉ lấy điểm cao nhất của các lần
thi).*/

--CÁCH 1

SELECT HOCVIEN.*, DIEM AS 'Điểm thi CSDL cao nhất'
FROM HOCVIEN, KETQUATHI, MONHOC
WHERE
	HOCVIEN.MAHV = KETQUATHI.MAHV
	AND KETQUATHI.MAMH = MONHOC.MAMH
	AND TENMH = N'Cơ sở dữ liệu'
	AND DIEM = (
		SELECT MAX(DIEM) 
		FROM KETQUATHI, MONHOC
		WHERE
			KETQUATHI.MAMH = MONHOC.MAMH
			AND MAHV = HOCVIEN.MAHV
			AND TENMH = N'Cơ sở dữ liệu'
		GROUP BY MAHV
	)

--CÁCH 2

SELECT HOCVIEN.*, DIEM AS 'Điểm thi CSDL cao nhất'
FROM HOCVIEN
INNER JOIN KETQUATHI
ON HOCVIEN.MAHV = KETQUATHI.MAHV
INNER JOIN MONHOC
ON KETQUATHI.MAMH = MONHOC.MAMH
WHERE
	TENMH = N'Cơ sở dữ liệu'
	AND DIEM = (
		SELECT MAX(DIEM) 
		FROM KETQUATHI, MONHOC
		WHERE
			KETQUATHI.MAMH = MONHOC.MAMH
			AND MAHV = HOCVIEN.MAHV
			AND TENMH = N'Cơ sở dữ liệu'
		GROUP BY MAHV
	)

--CÂU 19 PHẦN 3
/*Khoa nào (mã khoa, tên khoa) được thành lập sớm nhất.*/

--CÁCH 1

SELECT MAKHOA, TENKHOA
FROM KHOA
WHERE NGTLAP = (
	SELECT MIN(NGTLAP) 
	FROM KHOA
	)

--CÁCH 2

SELECT TOP 1 WITH TIES MAKHOA, TENKHOA
FROM KHOA
ORDER BY NGTLAP ASC

--CÂU 20 PHẦN 3
/*Có bao nhiêu giáo viên có học hàm là “GS” hoặc “PGS”.*/

--CÁCH 1

SELECT COUNT(*) 'SO LUONG GIAO VIEN CO HOC HAM GS HOAC PHO GIAO SU'
FROM GIAOVIEN
WHERE HOCHAM = 'GS' OR HOCHAM = 'PGS'
GROUP BY HOCHAM

--CÁCH 2

SELECT COUNT(MAGV) 'SO LUONG GIAO VIEN CO HOC HAM GS HOAC PHO GIAO SU'
FROM GIAOVIEN
WHERE HOCHAM = 'GS' OR HOCHAM = 'PGS'
GROUP BY HOCHAM

--CÁCH 3

SELECT COUNT(MAGV) 'SO LUONG GIAO VIEN CO HOC HAM GS HOAC PHO GIAO SU'
FROM GIAOVIEN
WHERE HOCHAM IN ('GS', 'PGS')
GROUP BY HOCHAM

--CÁCH 4

SELECT HOCHAM, COUNT(*) 
FROM GIAOVIEN
WHERE HOCHAM = 'GS'
GROUP BY HOCHAM
UNION
SELECT HOCHAM, COUNT(*) 
FROM GIAOVIEN
WHERE HOCHAM = 'PGS'
GROUP BY HOCHAM

--MỞ RỘNG
SELECT COUNT(*) 'SO LUONG GIAO VIEN CO HOC HAM GS HOAC PHO GIAO SU'
FROM GIAOVIEN
WHERE HOCHAM NOT IN ('GS', 'PGS')

--CÂU 21 PHẦN 3
/*Thống kê có bao nhiêu giáo viên có học vị là “CN”, “KS”, “Ths”, “TS”, “PTS” trong mỗi khoa.*/

--CÁCH 1

SELECT MAKHOA, HOCVI, COUNT(*) 'SO LUONG GIAO VIEN'
FROM GIAOVIEN
GROUP BY MAKHOA, HOCVI
ORDER BY MAKHOA

--CÁCH 2

SELECT GIAOVIEN.MAKHOA, TENKHOA, HOCVI, COUNT(*)'SO LUONG GIAO VIEN'
FROM GIAOVIEN, KHOA 
WHERE GIAOVIEN.MAKHOA = KHOA.MAKHOA
GROUP BY GIAOVIEN.MAKHOA, TENKHOA, HOCVI
ORDER BY MAKHOA

--MỞ RỘNG
--GOM TS VÀ PTS

SELECT GIAOVIEN.MAKHOA, TENKHOA, HOCVI, COUNT(*)'SO LUONG GIAO VIEN'
FROM GIAOVIEN,KHOA
WHERE 
	GIAOVIEN.MAKHOA = KHOA.MAKHOA
	AND HOCVI = 'CN' OR HOCVI = 'KS' OR HOCVI = 'ThS'
GROUP BY GIAOVIEN.MAKHOA, TENKHOA, HOCVI
UNION
SELECT GIAOVIEN.MAKHOA, TENKHOA, HOCVI = 'PTS_TS', COUNT(*)'SO LUONG GIAO VIEN'
FROM GIAOVIEN,KHOA
WHERE 
	GIAOVIEN.MAKHOA = KHOA.MAKHOA
	AND HOCVI = 'TS' OR HOCVI = 'PTS' 
GROUP BY GIAOVIEN.MAKHOA, TENKHOA

--UPDATE HOCVI
UPDATE GIAOVIEN
SET HOCVI = 'TSKH'
WHERE HOCVI = 'TS'

UPDATE GIAOVIEN
SET HOCVI = 'TS'
WHERE HOCVI = 'PTS'

--CÂU 22 PHẦN 3
/*Mỗi môn học thống kê số lượng học viên theo kết quả (đạt và không đạt).*/

--CÁCH 1

SELECT MAMH, KQUA, COUNT(*) 'SO LUONG HOC VIEN'
FROM KETQUATHI
GROUP BY MAMH, KQUA
ORDER BY MAMH

--CÁCH 2

SELECT MONHOC.MAMH, TENMH, KQUA, COUNT(MAHV) 
FROM KETQUATHI, MONHOC
WHERE KETQUATHI.MAMH = MONHOC.MAMH
GROUP BY MONHOC.MAMH, TENMH, KQUA 
ORDER BY MAMH

--CÂU 23 PHẦN 3
/*Tìm giáo viên (mã giáo viên, họ tên) là giáo viên chủ nhiệm của một lớp, đồng thời dạy cho
lớp đó ít nhất một môn học.*/

-- CÁCH 1

SELECT DISTINCT GIAOVIEN.MAGV, HOTEN
FROM GIAOVIEN, LOP, GIANGDAY
WHERE 
	GIANGDAY.MALOP = LOP.MALOP
	AND GIANGDAY.MAGV = GIAOVIEN.MAGV
	AND GIAOVIEN.MAGV = LOP.MAGVCN

--CÁCH 2

SELECT MAGV, HOTEN
FROM GIAOVIEN, LOP
WHERE
	GIAOVIEN.MAGV = LOP.MAGVCN
	AND EXISTS (
		SELECT *
		FROM GIANGDAY
		WHERE 
			MAGV = GIAOVIEN.MAGV
			AND MALOP = LOP.MALOP
	)

--CÂU 24 PHẦN 3
/*Tìm họ tên lớp trưởng của lớp có sỉ số cao nhất.*/

SELECT CONCAT(HO,' ',TEN) AS 'HOTEN LOP TRUONG'
FROM HOCVIEN, LOP
WHERE 
	HOCVIEN.MAHV = LOP.TRGLOP
	AND LOP.SISO = (
		SELECT MAX(SISO)
		FROM LOP
	)

--CÂU 25 PHẦN 3
/*Tìm họ tên những LOPTRG thi không đạt quá 3 môn (mỗi môn đều thi không đạt ở tất cả các lần thi).*/

SELECT CONCAT(HO,' ',TEN) AS 'HOTEN LOP TRUONG'
FROM HOCVIEN, LOP, KETQUATHI
WHERE 
	HOCVIEN.MAHV = LOP.TRGLOP
	AND HOCVIEN.MAHV = KETQUATHI.MAHV
GROUP BY TRGLOP, HO, TEN
HAVING COUNT(*) > 3

--CÂU 26 PHẦN 3
/*Tìm học viên (mã học viên, họ tên) có số môn đạt điểm 9,10 nhiều nhất.*/

SELECT TOP 1 WITH TIES
	HOCVIEN.MAHV, CONCAT(HO,' ',TEN) AS 'HOTEN'
FROM HOCVIEN, KETQUATHI
WHERE 
	HOCVIEN.MAHV = KETQUATHI.MAHV
	AND (DIEM = 9
	OR DIEM = 10)
GROUP BY HOCVIEN.MAHV, HO, TEN
ORDER BY COUNT(*) DESC

--CÂU 27 PHẦN 3
/*Trong từng lớp, tìm học viên (mã học viên, họ tên) có số môn đạt điểm 9,10 nhiều nhất.*/
SELECT MALOP, MAHV, HOTEN
FROM (
	SELECT  MALOP, HOCVIEN.MAHV, (HO +' '+ TEN) HOTEN, COUNT(*) SOLUONGDIEM, 
			RANK() OVER (PARTITION BY MALOP ORDER BY COUNT(*) DESC) AS XEPHANG
	FROM HOCVIEN, KETQUATHI
	WHERE
		HOCVIEN.MAHV = KETQUATHI.MAHV
		AND DIEM >= 9
	GROUP BY MALOP, HOCVIEN.MAHV, HO, TEN
) AS A
WHERE A.XEPHANG = 1

--CÂU 28 PHẦN 3
/*Trong từng học kỳ của từng năm, mỗi giáo viên phân công dạy bao nhiêu môn học, bao nhiêu lớp.*/

SELECT MAGV,
COUNT(DISTINCT MAMH) 'SO MON HOC',
COUNT(DISTINCT MAMH) 'SO LOP'
FROM GIANGDAY
GROUP BY MAGV

--CÂU 29 PHẦN 3
/*Trong từng học kỳ của từng năm, tìm giáo viên (mã giáo viên, họ tên) giảng dạy nhiều nhất.*/

SELECT HOCKY, NAM, A.MAGV, HOTEN
FROM GIAOVIEN, (
	SELECT HOCKY, NAM, MAGV, 
	RANK() OVER (PARTITION BY HOCKY, NAM ORDER BY COUNT(*) DESC) AS XEPHANG
	FROM GIANGDAY
	GROUP BY HOCKY, NAM, MAGV
) AS A
WHERE
	A.MAGV = GIAOVIEN.MAGV
	AND XEPHANG = 1
ORDER BY NAM, HOCKY

--CÂU 30 PHẦN 3
/*Tìm môn học (mã môn học, tên môn học) có nhiều học viên thi không đạt (ở lần thi thứ 1) nhất.*/

SELECT TOP 1 WITH TIES 
	MONHOC.MAMH, TENMH
FROM MONHOC, KETQUATHI
WHERE
	MONHOC.MAMH = KETQUATHI.MAMH
	AND LANTHI = 1
	AND KQUA = 'Không Đạt'
GROUP BY MONHOC.MAMH, TENMH
ORDER BY COUNT(*) DESC

--CÂU 31 PHẦN 3
/*Tìm học viên (mã học viên, họ tên) thi môn nào cũng đạt (chỉ xét lần thi thứ 1).*/

SELECT DISTINCT HOCVIEN.MAHV, CONCAT(HO, ' ', TEN) HOTEN
FROM HOCVIEN, KETQUATHI
WHERE
	HOCVIEN.MAHV = KETQUATHI.MAHV
	AND NOT EXISTS
	(
		SELECT *
		FROM KETQUATHI
		WHERE LANTHI = 1
		AND KQUA = 'Không Đạt'
		AND MAHV = HOCVIEN.MAHV
	)

--CÂU 32 PHẦN 3
/*Tìm học viên (mã học viên, họ tên) thi môn nào cũng đạt (chỉ xét lần thi sau cùng).*/

SELECT DISTINCT HOCVIEN.MAHV, CONCAT(HO, ' ', TEN) HOTEN
FROM HOCVIEN, KETQUATHI
WHERE
	HOCVIEN.MAHV = KETQUATHI.MAHV
	AND NOT EXISTS
	(
		SELECT *
		FROM KETQUATHI
		WHERE LANTHI = (
			SELECT MAX(LANTHI)
			FROM KETQUATHI
			WHERE MAHV = HOCVIEN.MAHV
			GROUP BY MAHV
		)
		AND KQUA = 'Không Đạt'
		AND MAHV = HOCVIEN.MAHV
	)

--CÂU 33 PHẦN 3
/*Tìm học viên (mã học viên, họ tên) đã thi tất cả các môn đều đạt (chỉ xét lần thi thứ 1).*/

SELECT MAHV, CONCAT(HO, ' ', TEN) HOTEN
FROM HOCVIEN
WHERE NOT EXISTS
(
	SELECT *
	FROM MONHOC
	WHERE NOT EXISTS
	(
		SELECT * 
		FROM KETQUATHI
		WHERE
			KETQUATHI.MAMH = MONHOC.MAMH
			AND KETQUATHI.MAHV = HOCVIEN.MAHV
			AND LANTHI = 1
			AND KQUA = N'Đạt'
	)
)

--CÂU 34 PHẦN 3 
/*Tìm học viên (mã học viên, họ tên) đã thi tất cả các môn đều đạt (chỉ xét lần thi sau cùng).*/

SELECT MAHV, CONCAT(HO, ' ', TEN) HOTEN
FROM HOCVIEN
WHERE NOT EXISTS
(
	SELECT *
	FROM MONHOC
	WHERE NOT EXISTS
	(
		SELECT * 
		FROM KETQUATHI
		WHERE
			KETQUATHI.MAMH = MONHOC.MAMH
			AND KETQUATHI.MAHV = HOCVIEN.MAHV
			AND LANTHI = (
				SELECT MAX(LANTHI)
				FROM KETQUATHI
				WHERE MAHV = HOCVIEN.MAHV
				GROUP BY MAHV
			)
			AND KQUA = N'Đạt'
	)
)

--CÂU 35 PHẦN 3
/*Tìm học viên (mã học viên, họ tên) có điểm thi cao nhất trong từng môn (lấy điểm ở lần
thi sau cùng).*/

SELECT MAMH, MAHV, HOTEN
FROM
(
	SELECT MAMH, HOCVIEN.MAHV, CONCAT(HO, ' ', TEN) HOTEN, 
	RANK() OVER (
		PARTITION BY MAMH
		ORDER BY MAX(DIEM)
		DESC
	) AS XEPHANG
	FROM HOCVIEN, KETQUATHI
	WHERE
		HOCVIEN.MAHV = KETQUATHI.MAHV
		AND LANTHI = (
			SELECT MAX(LANTHI)
			FROM KETQUATHI
			WHERE MAHV = HOCVIEN.MAHV
			GROUP BY MAHV
		)
	GROUP BY MAMH, HOCVIEN.MAHV, HO, TEN
) AS A
WHERE XEPHANG = 1

--CÂU 5 PHẦN 1
/*Kết quả thi là “Dat” nếu điểm từ 5 đến 10 và “Khong dat” nếu điểm nhỏ hơn 5.*/

ALTER TABLE KETQUATHI ADD CONSTRAINT CHECK_KETQUA CHECK
(	
	(KQUA = 'Đạt' AND DIEM BETWEEN 5 AND 10)
	OR (KQUA = 'Không Đạt' AND DIEM < 5)
)

--CÂU 6 PHẦN 1
/*Học viên thi một môn tối đa 3 lần.*/

ALTER TABLE KETQUATHI ADD CONSTRAINT CHECK_LANTHI CHECK 
(
	LANTHI <= 3
)

--CÂU 7 PHẦN 1
/*Học kỳ chỉ có giá trị từ 1 đến 3.*/

ALTER TABLE GIANGDAY ADD CONSTRAINT CHECK_HOCKY CHECK 
(
	HOCKY BETWEEN 1 AND 3
)

--CÂU 8 PHẦN 1
/*Học vị của giáo viên chỉ có thể là “CN”, “KS”, “Ths”, ”TS”, ”PTS”. CẬP NHẬT DỮ LIỆU TIẾN SĨ KHOA HỌC*/

ALTER TABLE GIAOVIEN ADD CONSTRAINT CHECK_HOCVI CHECK 
(
	HOCVI IN ('CN', 'KS', 'Ths', 'TS', 'TSKH')
)

--CÂU 9 PHẦN 1
/*Lớp trưởng của một lớp phải là học viên của lớp đó.*/

CREATE TRIGGER TRG_LOP_LOPTRUONG
ON LOP
FOR INSERT, UPDATE
AS
BEGIN
	DECLARE @TRGLOP CHAR(5), @MALOP CHAR(3), @MAHV CHAR(5)
	
	SELECT @TRGLOP = TRGLOP, @MALOP = MALOP
	FROM inserted
	
	SELECT @MAHV = MAHV
	FROM HOCVIEN
	
	WHERE MAHV = @TRGLOP AND MALOP = @MALOP
	IF (@MAHV <> @TRGLOP)
		BEGIN
			PRINT 'ERROR: LỚP TRƯỞNG PHẢI LÀ THÀNH VIÊN CỦA LỚP'
			ROLLBACK TRANSACTION
		END
	ELSE 
		PRINT 'SUCCESS'
END

--CÂU 10 PHẦN 1
/*Trưởng khoa phải là giáo viên thuộc khoa và có học vị “TS” hoặc “PTS”.*/

CREATE TRIGGER TRG_KHOA_TRGKHOA
ON KHOA
FOR INSERT, UPDATE
AS
BEGIN
	DECLARE @MAGV CHAR(4), @TRGKHOA CHAR(4), @MAKHOA VARCHAR(4)

	SELECT @TRGKHOA = TRGKHOA, @MAKHOA = MAKHOA
	FROM KHOA

	SELECT @MAGV = MAGV
	FROM GIAOVIEN

	WHERE MAKHOA = @MAKHOA 
	AND @TRGKHOA = @MAGV
	AND HOCVI IN ('TS', 'TSKH')

	IF(@TRGKHOA <> @MAGV)
	BEGIN
		PRINT 'ERROR'
		ROLLBACK TRANSACTION
	END
	ELSE
	BEGIN
		PRINT 'SUCCESS'
	END
END

--CÂU 11 PHẦN 1
/*Học viên ít nhất là 18 tuổi.*/

ALTER TABLE HOCVIEN ADD CONSTRAINT CHECK_TUOI CHECK 
(
	YEAR(GETDATE()) - YEAR(NGSINH) >= 18
)

--CÂU 12 PHẦN 1
/*Giảng dạy một môn học ngày bắt đầu (TUNGAY) phải nhỏ hơn ngày kết thúc
(DENNGAY).*/

ALTER TABLE GIANGDAY ADD CONSTRAINT CHECK_GIANGDAY CHECK 
(
	TUNGAY < DENNGAY
)

--CÂU 13 PHẦN 1
/*Giáo viên khi vào làm ít nhất là 22 tuổi.*/

ALTER TABLE GIAOVIEN ADD CONSTRAINT CHECK_TUOILAM CHECK 
(
	YEAR(NGVL) - YEAR(NGAYSINH) >= 22
)

--CÂU 14 PHẦN 1
/*Tất cả các môn học đều có số tín chỉ lý thuyết và tín chỉ thực hành chênh lệch nhau không
quá 3.*/

ALTER TABLE MONHOC ADD CONSTRAINT CHECK_TINCHI CHECK 
(
	ABS(TCLT - TCTH) <= 3
	OR TCTH = 0
)

--CÂU 15 PHẦN 1
/*Học viên chỉ được thi một môn học nào đó khi lớp của học viên đã học xong môn học này.*/

CREATE TRIGGER TRG_KETQUATHI_HOCVIEN
ON KETQUATHI
FOR	INSERT, UPDATE
AS
	DECLARE	@NGTHI SMALLDATETIME, @DENNGAY SMALLDATETIME

	SELECT @NGTHI = NGTHI, @DENNGAY = DENNGAY
	FROM INSERTED A, HOCVIEN B, GIANGDAY C
	WHERE	
		A.MAHV = B.MAHV 
		AND B.MALOP = C.MALOP 
		AND A.MAMH = C.MAMH
	
	IF(@NGTHI > @DENNGAY)
		PRINT 'SUCCESS'
	ELSE
		BEGIN
			ROLLBACK TRAN
			PRINT 'ERROR'
		END

--CÂU 16 PHẦN 1
/*Mỗi học kỳ của một năm học, một lớp chỉ được học tối đa 3 môn.*/

CREATE TRIGGER TRG_GIANGDAY_MONHOC
ON GIANGDAY
FOR	INSERT, UPDATE
AS
	DECLARE	@SL_MONHOC INT

	SELECT @SL_MONHOC = COUNT(A.MAMH)
	FROM GIANGDAY A, INSERTED B
	WHERE	
		A.MALOP = B.MALOP 
		AND A.HOCKY = B.HOCKY 
		AND A.NAM = B.NAM

	IF(@SL_MONHOC = 4)
		BEGIN
			ROLLBACK TRAN
			PRINT 'ERROR'
		END

--CÂU 17 PHẦN 1
/*Sỉ số của một lớp bằng với số lượng học viên thuộc lớp đó.*/

CREATE TRIGGER TRG_LOP_SISO
ON LOP
FOR	INSERT, UPDATE
AS
	DECLARE @SISO TINYINT, @MALOP CHAR(3)

	SELECT @SISO = SISO , @MALOP = MALOP
	FROM INSERTED A

	IF(@SISO <> (
			SELECT COUNT(MAHV)
			FROM HOCVIEN HV
			WHERE HV.MALOP = @MALOP
			)
		)
	BEGIN
		PRINT 'ERROR'
		ROLLBACK TRANSACTION
	END
	ELSE
		PRINT 'SUCCESS'

		
--CÂU 18 PHẦN 1
/*Trong quan hệ DIEUKIEN giá trị của thuộc tính MAMH và MAMH_TRUOC trong cùng
một bộ không được giống nhau (“A”,”A”) và cũng không tồn tại hai bộ (“A”,”B”) và
(“B”,”A”).*/

CREATE TRIGGER TRG_DIEUKIEN_ABBA
ON	DIEUKIEN
FOR	INSERT, UPDATE
AS
	DECLARE	@MAMH VARCHAR(10), @MAMH_TRUOC VARCHAR(10)

	SELECT	@MAMH = MAMH, @MAMH_TRUOC = MAMH_TRUOC
	FROM INSERTED

	IF (
		(@MAMH = @MAMH_TRUOC) OR
		(@MAMH IN (
			SELECT MAMH_TRUOC
			FROM DIEUKIEN
			WHERE MAMH = @MAMH_TRUOC
			)
		)
		OR
	    (@MAMH_TRUOC IN (
			SELECT MAMH
			FROM DIEUKIEN
			WHERE MAMH_TRUOC = @MAMH
			)
		)
	)
		BEGIN
			ROLLBACK TRAN
			PRINT 'ERROR'
		END

--CÂU 19 PHẦN 1
/*Các giáo viên có cùng học vị, học hàm, hệ số lương thì mức lương bằng nhau.*/

CREATE TRIGGER TRG_GIAOVIEN_HOCHAMHOCVI
ON	GIAOVIEN
FOR	INSERT, UPDATE
AS
	DECLARE	@MUCLUONG MONEY, @MAGV CHAR(4)
	
	SELECT DISTINCT @MUCLUONG = A.MUCLUONG, @MAGV = B.MAGV
	FROM GIAOVIEN A, INSERTED B
	WHERE 
		A.HOCHAM = B.HOCHAM 
		AND A.HOCVI = B.HOCVI 
		AND A.HESO = B.HESO 
		AND A.MAGV <> B.MAGV
	
	UPDATE GIAOVIEN
	SET MUCLUONG = @MUCLUONG	
	WHERE MAGV = @MAGV

--CÂU 20 PHẦN 1
/*Học viên chỉ được thi lại (lần thi >1) khi điểm của lần thi trước đó dưới 5.*/

CREATE TRIGGER TRG_KETQUATHI_THILAI
ON KETQUATHI
FOR INSERT, UPDATE
AS
	DECLARE	@LANTHI INT, @DIEM NUMERIC(4,2)
		
	SELECT @LANTHI = LANTHI
	FROM INSERTED

	IF(@LANTHI > 1)
		BEGIN
			SELECT @DIEM = B.DIEM
			FROM INSERTED A, KETQUATHI B
			WHERE	
				A.MAHV = B.MAHV 
				AND A.MAMH = B.MAMH 
				AND B.LANTHI = @LANTHI - 1

			IF(@DIEM >= 5)
				BEGIN
					ROLLBACK TRAN
					PRINT 'PASS'
				END
		END
	DELETE FROM	KETQUATHI
	WHERE LANTHI > @LANTHI

--CÂU 21 PHẦN 1
/*Ngày thi của lần thi sau phải lớn hơn ngày thi của lần thi trước (cùng học viên, cùng môn học).*/

CREATE TRIGGER TRG_KETQUATHI_LANTHI
ON KETQUATHI
FOR INSERT, UPDATE
AS
	DECLARE @LANTHI TINYINT, @MAHV CHAR(5), @NGTHI SMALLDATETIME, 
			@MAMH CHAR(10), @LANTHI2 TINYINT, @NGTHI2 SMALLDATETIME

	SELECT @LANTHI = LANTHI, @MAHV = MAHV, @NGTHI= NGTHI, @MAMH = MAMH
	FROM INSERTED

	SELECT @LANTHI2 = LANTHI, @NGTHI2 = NGTHI  
	FROM KETQUATHI
	WHERE 
		@MAHV = MAHV
		AND @MAMH = MAMH

	IF(@LANTHI = @LANTHI2 + 1 
	AND @NGTHI2 < @NGTHI)
	BEGIN
		PRINT 'ERROR'
		ROLLBACK TRANSACTION
	END
	ELSE
		PRINT 'SUCCESS'

--CÂU 22 PHẦN 1
/*Học viên chỉ được thi những môn mà lớp của học viên đó đã học xong.*/

CREATE TRIGGER TRG_KETQUATHI_KIEMTRATHI
ON KETQUATHI
FOR INSERT, UPDATE
AS
	DECLARE @MAMH CHAR(10), @MAHV CHAR(5), @NGKT SMALLDATETIME, @NGTHI SMALLDATETIME

	SELECT @MAHV = MAHV, @NGTHI = NGTHI, @MAMH = MAMH 
	FROM INSERTED

	SELECT @NGKT = DENNGAY 
	FROM GIANGDAY
	WHERE @MAMH = MAMH

	IF(@NGKT > @NGTHI)
	BEGIN
		PRINT 'ERROR'
		ROLLBACK TRANSACTION
	END
	ELSE
		PRINT 'SUCCESS'

--CÂU 23 PHẦN 1
/*Khi phân công giảng dạy một môn học, phải xét đến thứ tự trước sau giữa các môn học (sau
khi học xong những môn học phải học trước mới được học những môn liền sau).*/

CREATE TRIGGER TRG_GIANGDAY_DIEUKIEN
ON GIANGDAY
FOR INSERT, UPDATE
AS
	DECLARE @MAMH CHAR(10), @MALOP CHAR(3), @MAMH_TRUOC CHAR(10),@MAMH2 CHAR(10)
	
	SELECT @MALOP = MALOP, @MAMH = MAMH
	FROM INSERTED 

	SELECT @MAMH_TRUOC = MAMH_TRUOC 
	FROM DIEUKIEN
	WHERE @MAMH = MAMH

	SELECT @MAMH2 = MAMH 
	FROM GIANGDAY
	WHERE @MALOP = MALOP 

	IF(@MAMH_TRUOC <> @MAMH2)
	BEGIN
		PRINT 'ERROR'
		ROLLBACK TRANSACTION
	END
	ELSE
		PRINT 'SUCCESS'

--CÂU 24 PHẦN 1
/*Giáo viên chỉ được phân công dạy những môn thuộc khoa giáo viên đó phụ trách.*/

CREATE TRIGGER TRG_GIANGDAY_PHANCONG
ON GIANGDAY
FOR	INSERT, UPDATE
AS
	DECLARE	@MAKHOA1 CHAR(4), @MAKHOA2 CHAR(4)

	SELECT @MAKHOA1 = B.MAKHOA, @MAKHOA2 = C.MAKHOA
	FROM INSERTED A, MONHOC B, GIAOVIEN C
	WHERE	
		A.MAMH = B.MAMH 
		AND A.MAGV = C.MAGV

	IF(@MAKHOA1 <> @MAKHOA2)
		BEGIN
			ROLLBACK TRAN
			PRINT 'ERROR'
		END
	ELSE
		PRINT 'SUCCESS'